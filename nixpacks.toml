[phases.setup]
nixPkgs = [
    "python312",
    "chromium",
    "nss",
    "freetype",
    "harfbuzz",
    "ca-certificates",
    "fontconfig",
    "libjpeg62",
    "libjpeg_turbo",
    "zlib",
    "libpng",
    "libtiff",
    "libwebp",
    "openjpeg"
]

[phases.install]
cmds = [
    "pip install --upgrade pip",
    "pip uninstall -y Pillow",
    "pip install --no-cache-dir Pillow==10.2.0",
    "pip install -r requirements.txt",
    "playwright install chromium --with-deps",
    # âœ… Move browsers to a persistent path so Railway keeps them
    "mkdir -p /ms-playwright && mv /root/.cache/ms-playwright/* /ms-playwright/"
]

[phases.build]
cmds = [
  "playwright install chromium --with-deps",
  "mkdir -p logs temp",
  "chmod 755 logs temp"
]

[start]
cmd = "bash start.sh"

[variables]
PYTHONUNBUFFERED = "1"
PLAYWRIGHT_BROWSERS_PATH = "/ms-playwright"
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD = "0"

[env]
LD_LIBRARY_PATH = "/nix/store/*-libjpeg-turbo-*/lib:/nix/store/*-libjpeg-*/lib:$LD_LIBRARY_PATH"
